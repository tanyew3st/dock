{% extends 'base.html' %}
{% block title %}Results{% endblock %}

{% block content %}
    <script language="javascript">
        var max = 0
        var finished = false
        var currentstr = 0
        var structures
        var protein
        var ligand
        var base
        var max
        var affinity

        // getting the structure names
        function func1(ligand, protein) {
            var url = window.location.href
            base = url.substr(0, url.indexOf('/run'));
            console.log(base);
            var o = {
                "bod": "hello world"
            }
            this.protein = protein
            this.ligand = ligand

            // getting from the server
            fetch(base + '/structures/get/' + protein)
                .then(response => response.json())
                .then(json => {
                    console.log(json)
                    finished = false
                    currentstr = 0
                    structures = json
                    max = structures.length
                    this.affinity = new Array(max)
                    createTable(structures)
                    getAffinity()
                })
        }

        function getAffinity() {
                if (structures[currentstr] == ".DS_Store") {
                    currentstr++
                }
                console.log("working... testing structure " + structures[currentstr])
                // need to dock every structure with every protein
                let obj = {
                    "protein": protein,
                    "structure": structures[currentstr],
                    "ligand": ligand
                }
                fetch(base + '/dock', {
                    method: "POST",
                    body: JSON.stringify(obj)
                }).then(response => response.json())
                .then(res => {
                    updateTable()
                    console.log(this.affinity)
                    console.log(res)
                    keepgoing = true
                    this.affinity[currentstr] = res['affinity']
                    currentstr++
                    if (currentstr === max) {
                        finished = true
                        console.log(this.affinity)
                    } else {
                        getAffinity()
                    }

                })
                console.log(obj)
        }

        function createTable(names) {
            document.getElementById("progress").style.width = "99%"
            document.getElementById("progress").innerHTML = "99%"

            for (let i = 0; i < names.length; i++) {
                let el = document.createElement("th");
                el.innerHTML = names[i]
                document.getElementById("structures").appendChild(el)

                let tw = document.createElement("td")
                tw.id = names[i]
                document.getElementById("affinities").appendChild(tw)
            }

            console.log(document.getElementById("strtable"));
        }

        function updateTable() {

        }

        function machinelearning(array) {
            fetch(base + '/run/ml/array', {
                method: "POST",
                body: JSON.stringify({"affinity": this.affinity})
            }).then(response => response.json())
            .then(res => {
                console.log(res)
            })
        }

    </script>

    <button class="btn btn-primary" onclick="func1('{{ ligand }}', '{{ protein }}')">Button</button>
    <div class="progress">
      <div class="progress-bar" id="progress" role="progressbar" style="width: 42%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">25%</div>
    </div>
    <table id="strtable" class="table table-bordered" style="max-width: 100% !important;">
      <thead>
        <tr id="structures">
          <th scope="col">Structures</th>
        </tr>
      </thead>
      <tbody>
        <tr id="affinities">
          <th scope="row">Affinity</th>
        </tr>
      </tbody>
    </table>
{% endblock %}